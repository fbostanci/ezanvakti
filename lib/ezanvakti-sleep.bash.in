#!/bin/bash
#
#
#
#                           Ezanvakti Sleep Yöntemi  Bileşeni 1.4
#

calisma_kodu="$1"

. @libdir@/@AD@/temel_islevler.bash

acilisa_baslatici_ekle
[[ ${calisma_kodu} = 657a616e76616b7469 ]] && (( ! ACILISTA_BASLAT )) && exit 0

bilesen_yukle mplayer_yonetici
(( OYNATICI_DURAKLAT )) && bilesen_yukle oynatici_duraklat
renk_denetle

trap cikis_yap INT
function cikis_yap() {
  echo
  exit 0
}

function ezv_sleep_pid_denetle() {
  local ypid=$$

  if [[ -f /tmp/.ezv_sleep.pid && -n $(ps -p $( < /tmp/.ezv_sleep.pid) -o comm=) ]]
  then
      printf "%s: Yalnızca bir örneği çalışabilir.\n" "${AD}" >&2
      exit 1
  else
      printf "$ypid" > /tmp/.ezv_sleep.pid
  fi
}

# Dini günler için anımsatıcı
function gun_animsat() {
  local ozel_ileti

  # Eğer GUN_ANIMSAT değeri sıfır değilse girilen saniye değerini
  # bildirimin bekleme süresi olarak kullan.
  (( GUN_ANIMSAT )) && {
    if grep -q $(date +%d.%m.%Y) ${VERI_DIZINI}/veriler/gunler
    then
        ozel_ileti="\n\nBugün:  <b>$(grep $(date +%d.%m.%Y) ${VERI_DIZINI}/veriler/gunler | cut -d' ' -f2-)</b>"
    elif grep -q $(date -d 'tomorrow' +%d.%m.%Y) ${VERI_DIZINI}/veriler/gunler
    then
        ozel_ileti="\n\nYarın:  <b>$(grep $(date -d 'tomorrow' +%d.%m.%Y) ${VERI_DIZINI}/veriler/gunler | cut -d' ' -f2-)</b>"
    else
        ozel_ileti=''
    fi

    # eğer ozel_ileti boş (null) dönmemişse bildirimi gönder.
    [[ -n ${ozel_ileti} ]] && {
      notify-send "${AD^}" "${ozel_ileti}" -t $GUN_ANIMSAT"000" \
        -i ezanvakti -h int:transient:1
    }
  }
}

function ezan_vakitlerini_al() {
  bugun

  if (( UNIXSAAT <= sabah ))
  then
      (( ACILISTA_BASLAT == 2 )) && simdiki='İmsak' || simdiki='Sabah'
      vakit_ezani="${SABAH_EZANI}"
      vakit_saati_n=$sabah_n
      vakit_saati=$(( sabah + EZAN_OKUNMA_SURESI_FARKI ))
      ezan_okunsun_mu=${SABAH_EZANI_OKU}

  elif (( UNIXSAAT <= ogle ))
  then
      (( ACILISTA_BASLAT == 2 )) && {
        rm_sim='İftar'
        simdiki=''
        rm_vakit_saati_n="${aksam_n}"
      } || simdiki='Öğle'

      vakit_ezani="${OGLE_EZANI}"
      vakit_saati_n=$ogle_n
      vakit_saati=$(( ogle + EZAN_OKUNMA_SURESI_FARKI ))
      ezan_okunsun_mu=${OGLE_EZANI_OKU}

  elif (( UNIXSAAT <= ikindi ))
  then
      (( ACILISTA_BASLAT == 2 )) && {
        rm_sim='İftar'
        simdiki=''
        rm_vakit_saati_n="${aksam_n}"
      } || simdiki='İkindi'

      vakit_ezani="${IKINDI_EZANI}"
      vakit_saati_n=$ikindi_n
      vakit_saati=$(( ikindi + EZAN_OKUNMA_SURESI_FARKI ))
      ezan_okunsun_mu=${IKINDI_EZANI_OKU}

  elif (( UNIXSAAT <= aksam ))
  then
      (( ACILISTA_BASLAT == 2 )) && simdiki='İftar' || simdiki='Akşam'
      vakit_ezani="${AKSAM_EZANI}"
      vakit_saati_n=$aksam_n
      vakit_saati=$(( aksam + EZAN_OKUNMA_SURESI_FARKI ))
      ezan_okunsun_mu=${AKSAM_EZANI_OKU}

  elif (( UNIXSAAT <= yatsi ))
  then
      (( ACILISTA_BASLAT == 2 )) && simdiki='' || simdiki='Yatsı'
      vakit_ezani="${YATSI_EZANI}"
      vakit_saati_n=$yatsi_n
      vakit_saati=$(( yatsi + EZAN_OKUNMA_SURESI_FARKI ))
      ezan_okunsun_mu=${YATSI_EZANI_OKU}

  elif (( UNIXSAAT <= yeni_gun ))
  then
      vakit_saati=$yeni_gun
      simdiki=
  fi
}

function ezan_oku() {
  local ileti
  clear

  [[ ${simdiki} = @(İmsak|İftar) ]] && ileti='vakti' || ileti='namazı vakti'
  printf '%b%b\n' \
    "${RENK7}${RENK3}${ILCE}${RENK2} " \
    "için ${RENK3}${simdiki}${RENK2} ${ileti}${RENK5} $vakit_saati_n${RENK0}"

  notify-send "${ILCE} için" \
    "${simdiki} ${ileti}\n$vakit_saati_n" \
    -i ezanvakti -u critical -h int:transient:1 \
    -t $EZAN_BILDIRIM_SURESI"000"

  (( ezan_okunsun_mu )) || { sleep 1m; return 0; }
  bilesen_yukle mplayer_yonetici

  # Oynatıcı duraklatma etkin mi ezan okumadan değeri
  # denetle ve fonksiyonu çağır.
  (( OYNATICI_DURAKLAT )) && oynatici_islem ||
  { mplayer_calistir "${vakit_ezani}"
    (( EZAN_DUASI_OKU )) && mplayer_calistir "${EZAN_DUASI}"
  }
  clear
}

# Vakit ezanı okunmadan önce  anımsatma
function vakit_animsat() {
  local dakika_saniye animsatici_saniye ileti

  # Kullanıcı anımsatma değerini sıfır olarak belirlememişse
  (( VAKIT_ANIMSAT )) && {
    ezan_vakitlerini_al

    [[ -z $simdiki ]] && { sleep 59; vakit_animsat; }

    dakika_saniye=$(( VAKIT_ANIMSAT * 60 ))
    animsatici_saniye=$(( vakit_saati - dakika_saniye ))

    if (( $(( animsatici_saniye - 60 )) == UNIXSAAT ))
    then
        sleep $(( animsatici_saniye - $(date +%s) ))
    else
#       set -e
        while (( animsatici_saniye != UNIXSAAT ))
        do
          sleep 59; vakit_animsat
        done
    fi

    [[ ${simdiki} = @(İmsak|İftar) ]] && ileti='vakti olacak.' || ileti='ezanı okunacak.'
    notify-send "${AD^}" "$VAKIT_ANIMSAT dakika sonra $simdiki ${ileti}" \
      -u critical -t $BILGI_BILDIRIM_SURESI"000" \
      -i ezanvakti -h int:transient:1
    sleep 60; vakit_animsat
  }
}

# Vakitlerde ezan okunmasının ve bildirimin yönetildiği özyinelemeli ana fonksiyon.
function ezanvakti_bekle() {
  local ileti rm_sim_ileti
  ezan_vakitlerini_al

  [[ -z $simdiki ]] && {

    if [[ -n ${rm_sim} ]]
    then
        rm_sim_ileti="${rm_sim} vakti"
    else
        rm_sim_ileti='Yeni güm'
        rm_vakit_saati_n='00:00'
    fi

    printf '%b %b' "${RENK7}${RENK4}${rm_sim_ileti} için bekleniyor...${RENK0}"\
                   "${RENK2}(${RENK5}${rm_vakit_saati_n}${RENK2})${RENK0}\r"
    sleep 59; ezanvakti_bekle
  }

  if (( $(( vakit_saati - 60 )) == UNIXSAAT ))
  then
      printf '%b %b' "${RENK7}${RENK4}${simdiki} vakti için bekleniyor.${RENK0}"\
                     "${RENK2}(${RENK5}${vakit_saati_n}${RENK2})${RENK0}\r"
      sleep $(( vakit_saati - $(date +%s) ))
  else
      printf '%b %b' "${RENK7}${RENK4}${simdiki} vakti için bekleniyor.${RENK0}"\
                     "${RENK2}(${RENK5}${vakit_saati_n}${RENK2})${RENK0}\r"
#     set -e
      while (( vakit_saati != UNIXSAAT ))
      do
        sleep 59; ezanvakti_bekle
      done
  fi
  ezan_oku; ezanvakti_bekle
}

# Bileşen burdan yönetiliyor.
#
# 1: normal vakit ezanları
# 2: Vakit ezanları için ramazan kipi. (--ramazan)
ezv_sleep_pid_denetle; ezanveri_denetle
gun_animsat; vakit_animsat &
ezanvakti_bekle

# vim: set ft=sh ts=2 sw=2 et:
